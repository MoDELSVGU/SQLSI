DROP PROCEDURE IF EXISTS Query2;
/* SELECT Student_id FROM Student WHERE age > 18 */
DELIMITER //
CREATE PROCEDURE Query2(in _caller varchar(250), in _role varchar(250))
BEGIN
DECLARE _rollback int DEFAULT 0;
DECLARE EXIT HANDLER FOR SQLEXCEPTION
BEGIN
  SET _rollback = 1;
  ROLLBACK;
  RESIGNAL;
END;
START TRANSACTION;
DROP TEMPORARY TABLE IF EXISTS TEMP1;
CREATE TEMPORARY TABLE TEMP1 AS (
SELECT * FROM Student WHERE CASE auth_READ_Student_age(_caller, _role, Student_id) WHEN TRUE THEN age ELSE throw_error() END > 18
);
DROP TEMPORARY TABLE IF EXISTS TEMP2;
CREATE TEMPORARY TABLE TEMP2 AS (
SELECT Student_id AS Student_id FROM TEMP1
);
IF _rollback = 0
THEN SELECT * from TEMP2;
END IF;
END //
DELIMITER ;

